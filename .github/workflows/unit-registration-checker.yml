name: Unit Registration Checker

# Check for unit registration availability every 6 hours
on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-units:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      
      - name: Check Unit Registration Status
        id: check_units
        env:
          MMU_REG_NUMBER: ${{ secrets.MMU_REG_NUMBER }}
          MMU_PASSWORD: ${{ secrets.MMU_PASSWORD }}
        run: |
          echo "Checking unit registration availability..."
          python unit_registration_notifier.py
      
      - name: Send Status Email (Always)
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ steps.check_units.outputs.can_register == 'true' && '‚úÖ MMU Units Available!' || steps.check_units.outputs.registration_status == 'error' && '‚ö†Ô∏è MMU Registration Check - Error' || '‚ÑπÔ∏è MMU Registration Check - No Units Yet' }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: MMU Bot <${{ secrets.EMAIL_USERNAME }}>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #2196F3; color: white; padding: 20px; text-align: center; border-radius: 5px; }
                .status-available { background: #4CAF50; color: white; padding: 15px; margin: 20px 0; border-radius: 5px; }
                .status-error { background: #FF9800; color: white; padding: 15px; margin: 20px 0; border-radius: 5px; }
                .status-not-available { background: #9E9E9E; color: white; padding: 15px; margin: 20px 0; border-radius: 5px; }
                .units-list { background: #f5f5f5; padding: 15px; border-left: 4px solid #2196F3; margin: 20px 0; }
                .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
                .button { display: inline-block; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px; margin: 10px 0; }
                pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h2>üìö MMU Unit Registration Check</h2>
                  <p>Automated Status Report</p>
                </div>
                
                ${{ steps.check_units.outputs.can_register == 'true' && format('<div class="status-available"><h3>‚úÖ UNITS CAN BE REGISTERED!</h3><p>{0}</p></div>', steps.check_units.outputs.message) || steps.check_units.outputs.registration_status == 'error' && format('<div class="status-error"><h3>‚ö†Ô∏è Error Occurred</h3><p>{0}</p></div>', steps.check_units.outputs.error_message) || '<div class="status-not-available"><h3>‚ÑπÔ∏è No Units Available Yet</h3><p>Registration is not open at this time.</p></div>' }}
                
                <h3>üìä Check Details</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr style="background: #f5f5f5;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Status:</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${{ steps.check_units.outputs.registration_status }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Can Register:</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${{ steps.check_units.outputs.can_register == 'true' && '‚úÖ YES' || '‚ùå NO' }}</td>
                  </tr>
                  <tr style="background: #f5f5f5;">
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Units Found:</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${{ steps.check_units.outputs.unit_count || '0' }}</td>
                  </tr>
                  <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>Checked At:</strong></td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${{ github.event.repository.updated_at }}</td>
                  </tr>
                </table>
                
                ${{ steps.check_units.outputs.can_register == 'true' && format('<h3>üìã Available Units</h3><div class="units-list"><pre>{0}</pre></div><a href="https://studentportal.mmu.ac.ke/UnitRegistration.aspx" class="button">üîó Go to Registration Page</a>', steps.check_units.outputs.units_list) || '' }}
                
                ${{ steps.check_units.outputs.registration_status == 'error' && format('<h3>‚ùó Error Message</h3><div class="units-list">{0}</div><p><em>This usually means you need to meet payment requirements before registering.</em></p>', steps.check_units.outputs.error_message) || '' }}
                
                <div class="footer">
                  <p><strong>Next Check:</strong> In 6 hours</p>
                  <p><em>This is an automated status report from your MMU Portal Bot.</em></p>
                  <p>ü§ñ Powered by GitHub Actions | üìß Notification System Active</p>
                </div>
              </div>
            </body>
            </html>
        continue-on-error: true
      
      - name: Create GitHub Issue (Units Available)
        if: steps.check_units.outputs.can_register == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const title = 'üéì Units Available for Registration!';
            const body = `## ‚úÖ Units Can Be Registered!
            
            **Status:** ${{ steps.check_units.outputs.message }}
            **Unit Count:** ${{ steps.check_units.outputs.unit_count }}
            **Checked At:** ${new Date().toLocaleString()}
            
            ### Available Units:
            \`\`\`
            ${{ steps.check_units.outputs.units_list }}
            \`\`\`
            
            ### Action Required:
            1. Go to [MMU Student Portal](https://studentportal.mmu.ac.ke/UnitRegistration.aspx)
            2. Select registration type: Course Registration
            3. Click "Get Units To Register"
            4. Check the boxes for units you want
            5. Submit registration
            
            ---
            *This issue was automatically created by the Unit Registration Checker workflow.*`;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'unit-registration'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['unit-registration', 'notification']
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `### üîî Update: Units Still Available!\n\n${body}`
              });
            }
      
      - name: Upload Debug Files
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: registration-check-logs
          path: |
            *.log
            *.html
          retention-days: 3
          if-no-files-found: ignore
