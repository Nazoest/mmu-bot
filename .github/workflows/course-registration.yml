name: MMU Course Registration

# Run every 6 hours
on:
  schedule:
    - cron: '0 */6 * * *'  # At minute 0 past every 6th hour
  workflow_dispatch:  # Allow manual trigger

jobs:
  course-registration:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Chrome and ChromeDriver
        run: |
          # Install Chrome
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      
      - name: Check Course Registration Status
        id: check_registration
        env:
          MMU_REG_NUMBER: ${{ secrets.MMU_REG_NUMBER }}
          MMU_PASSWORD: ${{ secrets.MMU_PASSWORD }}
        run: |
          echo "Checking course registration availability..."
          python course_registration_bot.py
      
      - name: Download Previous State
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: course-registration-state
          path: ./previous_state
      
      - name: Parse Registration Output and Detect Changes
        id: parse_output
        if: always()
        run: |
          if [ -f "registration_output.json" ]; then
            echo "Reading registration output..."
            python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          import os
          
          def write_multiline_output(key, value):
              """Safely write multiline output to GITHUB_OUTPUT"""
              value = str(value).replace('%', '%25').replace('\n', '%0A').replace('\r', '%0D')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"{key}={value}\n")
          
          def write_output(key, value):
              """Write single line output"""
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"{key}={value}\n")
          
          try:
              # Load current state
              with open('registration_output.json', 'r') as f:
                  current = json.load(f)
              
              # Load previous state if exists
              previous = None
              try:
                  with open('previous_state/registration_output.json', 'r') as f:
                      previous = json.load(f)
                  print("Previous state found")
              except:
                  print("No previous state found (first run)")
              
              # Extract current data
              status = current.get('status', 'unknown')
              message = current.get('message', 'No message')
              error = current.get('error', '')
              units = current.get('units', [])
              
              # Determine if we should notify
              should_notify = False
              change_reason = ""
              
              if previous is None:
                  # First run - always notify
                  should_notify = True
                  change_reason = "First Check - Course Registration Status"
                  print("First run detected - will send notification")
              else:
                  # Compare with previous state
                  prev_status = previous.get('status', 'unknown')
                  prev_units = previous.get('units', [])
                  prev_error = previous.get('error', '')
                  
                  # Check if status changed
                  if status != prev_status:
                      should_notify = True
                      if status == 'success':
                          change_reason = "‚úÖ Units Now Available!"
                      elif status == 'error':
                          change_reason = "‚ö†Ô∏è Registration Error - Status Changed"
                      else:
                          change_reason = "üìä Status Changed"
                      print(f"Status changed: {prev_status} ‚Üí {status}")
                  
                  # Check if units changed (for success status)
                  elif status == 'success' and set(units) != set(prev_units):
                      should_notify = True
                      unit_diff = len(units) - len(prev_units)
                      if unit_diff > 0:
                          change_reason = f"‚ú® {unit_diff} New Unit(s) Available!"
                      else:
                          change_reason = "üìù Available Units Changed"
                      print(f"Units changed: {len(prev_units)} ‚Üí {len(units)}")
                  
                  # Check if error message changed (for error status)
                  elif status == 'error' and error != prev_error:
                      should_notify = True  
                      change_reason = "‚ö†Ô∏è Different Error - Check Details"
                      print(f"Error message changed")
                  
                  else:
                      should_notify = False
                      print("No changes detected - skipping notification")
              
              # Write outputs (using safe multiline writing)
              write_output('status', status)
              write_multiline_output('message', message)
              write_multiline_output('error', error or '')
              write_output('unit_count', len(units))
              write_output('should_notify', 'true' if should_notify else 'false')
              write_multiline_output('change_reason', change_reason)
              
              # Format units as HTML list items
              if units:
                  units_html = ''.join([f'<li>{unit}</li>' for unit in units])
                  write_multiline_output('units_html', units_html)
              else:
                  write_output('units_html', '')
              
              print(f"Status: {status}")
              print(f"Message: {message}")
              print(f"Units found: {len(units)}")
              print(f"Should notify: {should_notify}")
              print(f"Change reason: {change_reason}")
              
          except Exception as e:
              print(f"Error parsing output: {e}")
              import traceback
              traceback.print_exc()
              write_output('status', 'error')
              write_multiline_output('message', f'Failed to parse output: {str(e)}')
              write_output('error', '')
              write_output('unit_count', '0')
              write_output('units_html', '')
              write_output('should_notify', 'true')  # Notify on errors
              write_multiline_output('change_reason', '‚ö†Ô∏è Bot Error - Check Logs')
          PYTHON_SCRIPT
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "message=Output file not found" >> $GITHUB_OUTPUT
            echo "error=" >> $GITHUB_OUTPUT
            echo "unit_count=0" >> $GITHUB_OUTPUT
            echo "units_html=" >> $GITHUB_OUTPUT
          fi
      
      
      - name: Send Email with Details
        if: steps.parse_output.outputs.should_notify == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ${{ steps.parse_output.outputs.change_reason || 'üìä Course Registration Update' }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: MMU Bot <${{ secrets.EMAIL_USERNAME }}>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background: #f4f4f4; }
                .container { max-width: 600px; margin: 20px auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
                .header { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 30px 20px; text-align: center; }
                .header.error { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
                .header.warning { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
                .header h2 { margin: 0; font-size: 24px; }
                .header p { margin: 5px 0 0 0; opacity: 0.9; }
                .content { padding: 30px; }
                .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: bold; margin: 15px 0; }
                .status-success { background: #E8F5E9; color: #2E7D32; }
                .status-error { background: #FFF3E0; color: #E65100; }
                .units-box { background: #E3F2FD; border-left: 4px solid #2196F3; padding: 20px; margin: 20px 0; border-radius: 5px; }
                .units-box h4 { margin-top: 0; color: #1976D2; }
                .units-list { list-style: none; padding: 0; margin: 10px 0; }
                .units-list li { padding: 10px; margin: 5px 0; background: white; border-radius: 5px; border-left: 3px solid #4CAF50; }
                .error-box { background: #FFF3E0; border-left: 4px solid #FF9800; padding: 20px; margin: 20px 0; border-radius: 5px; }
                .error-box h4 { margin-top: 0; color: #E65100; }
                .info-box { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 15px 0; }
                .button { display: inline-block; padding: 12px 30px; background: #2196F3; color: white !important; text-decoration: none; border-radius: 5px; margin: 15px 0; font-weight: bold; }
                .button:hover { background: #1976D2; }
                .footer { background: #f5f5f5; padding: 20px; text-align: center; font-size: 13px; color: #666; }
                .highlight { background: #FFF59D; padding: 2px 6px; border-radius: 3px; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header${{ steps.parse_output.outputs.status == 'error' && ' error' || steps.parse_output.outputs.status == 'no_units' && ' warning' || '' }}">
                  <h2>üìö MMU Course Registration Check</h2>
                  <p>Automated Status Report</p>
                </div>
                
                <div class="content">
                  <div class="status-badge status-${{ steps.parse_output.outputs.status == 'success' && 'success' || 'error' }}">
                    ${{ steps.parse_output.outputs.status == 'success' && '‚úÖ SUCCESS' || steps.parse_output.outputs.status == 'error' && '‚ö†Ô∏è ERROR' || 'üìä COMPLETE' }}
                  </div>
                  
                  <h3>${{ steps.parse_output.outputs.message }}</h3>
                  
                  ${{ steps.parse_output.outputs.unit_count > 0 && format('<div class="units-box"><h4>üìñ Available Units ({0} found):</h4><ul class="units-list">{1}</ul><p class="highlight"><strong>‚ö° Action Required:</strong> Units are available NOW! Log in to complete your registration.</p></div>', steps.parse_output.outputs.unit_count, steps.parse_output.outputs.units_html) || '' }}
                  
                  ${{ steps.parse_output.outputs.error != '' && format('<div class="error-box"><h4>‚ùå Error Details:</h4><p>{0}</p><p><em>This usually means registration is not currently allowed or you need to complete a payment.</em></p></div>', steps.parse_output.outputs.error) || '' }}
                  
                  <div class="info-box">
                    <p><strong>üïê Check Time:</strong> ${{ github.event.repository.updated_at }}</p>
                    <p><strong>üîÑ Workflow:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">#${{ github.run_number }}</a></p>
                    <p><strong>ÔøΩ Next Check:</strong> In 6 hours</p>
                  </div>
                  
                  <center>
                    <a href="https://studentportal.mmu.ac.ke/UnitRegistration.aspx" class="button">üîó Go to Registration Portal</a>
                  </center>
                </div>
                
                <div class="footer">
                  <p><strong>MMU Course Registration Bot</strong></p>
                  <p>Automated monitoring every 6 hours</p>
                  <p>ü§ñ Powered by GitHub Actions</p>
                </div>
              </div>
            </body>
            </html>
        continue-on-error: true
      
      - name: Save Current State for Next Run
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: course-registration-state
          path: registration_output.json
          retention-days: 30
          overwrite: true
      
      - name: Upload Logs and Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: course-registration-logs
          path: |
            *.log
            *.html
            registration_output.json
          retention-days: 7
          if-no-files-found: ignore
